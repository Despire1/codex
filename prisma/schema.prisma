generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Teacher {
  chatId                BigInt          @id
  username              String?
  name                  String?
  timezone              String?
  defaultLessonDuration Int             @default(60)
  reminderMinutesBefore Int             @default(30)
  lessonReminderEnabled Boolean         @default(true)
  lessonReminderMinutes Int             @default(30)
  dailySummaryEnabled   Boolean         @default(true)
  dailySummaryTime      String          @default("09:00")
  tomorrowSummaryEnabled Boolean        @default(false)
  tomorrowSummaryTime   String          @default("20:00")
  studentNotificationsEnabled Boolean   @default(true)
  studentUpcomingLessonTemplate String?
  studentPaymentDueTemplate String?
  studentPaymentRemindersEnabled Boolean @default(true)
  autoConfirmLessons    Boolean         @default(true)
  globalPaymentRemindersEnabled Boolean @default(true)
  paymentReminderDelayHours Int         @default(24)
  paymentReminderRepeatHours Int        @default(48)
  paymentReminderMaxCount Int           @default(3)
  notifyTeacherOnAutoPaymentReminder Boolean @default(false)
  notifyTeacherOnManualPaymentReminder Boolean @default(true)
  students              TeacherStudent[]
  homeworks             Homework[]
  lessons               Lesson[]
  notificationLogs      NotificationLog[]
  createdAt             DateTime        @default(now())
  authUser              TeacherAuth?
}

model Student {
  id                   Int                  @id @default(autoincrement())
  username             String?
  telegramId           BigInt?
  isActivated          Boolean              @default(false)
  activatedAt          DateTime?
  pricePerLesson       Int                  @default(0)
  paymentRemindersEnabled Boolean           @default(true)
  teacherLinks         TeacherStudent[]
  homeworks            Homework[]           @relation("HomeworkStudent")
  takenHomeworks       Homework[]           @relation("HomeworkTakenBy")
  lessons              Lesson[]
  lessonParticipations LessonParticipant[]
  paymentEvents        PaymentEvent[]
  notificationLogs     NotificationLog[]
  createdAt            DateTime             @default(now())
}

model TeacherStudent {
  id                 Int      @id @default(autoincrement())
  teacherId          BigInt
  studentId          Int
  customName         String
  autoRemindHomework Boolean @default(false)
  balanceLessons     Int     @default(0)
  pricePerLesson     Int     @default(0)
  isArchived         Boolean @default(false)
  payments           Payment[]

  teacher Teacher @relation(fields: [teacherId], references: [chatId])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([teacherId, studentId])
}

model Homework {
  id        Int      @id @default(autoincrement())
  text      String
  deadline  DateTime?
  status    String   @default("DRAFT") // values: DRAFT, ASSIGNED, IN_PROGRESS, DONE
  isDone    Boolean  @default(false)
  attachments String @default("[]")
  timeSpentMinutes Int?
  completedAt DateTime?
  takenAt   DateTime?
  takenByStudentId Int?
  studentId Int
  teacherId BigInt
  student   Student  @relation("HomeworkStudent", fields: [studentId], references: [id])
  teacher   Teacher  @relation(fields: [teacherId], references: [chatId])
  takenByStudent Student? @relation("HomeworkTakenBy", fields: [takenByStudentId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  lastReminderAt DateTime?
}

model Lesson {
  id                  Int                 @id @default(autoincrement())
  teacherId           BigInt
  studentId           Int
  price               Int                 @default(0)
  color               String              @default("blue")
  startAt             DateTime
  durationMinutes     Int
  status              String              @default("SCHEDULED") // values: SCHEDULED, COMPLETED, CANCELED
  isPaid              Boolean             @default(false)
  paidAt              DateTime?
  completedAt         DateTime?
  paymentStatus       LessonPaymentStatus @default(UNPAID)
  paidSource          LessonPaidSource    @default(NONE)
  lastPaymentReminderAt DateTime?
  paymentReminderCount Int               @default(0)
  lastPaymentReminderSource PaymentReminderSource?
  isRecurring         Boolean             @default(false)
  meetingLink         String?
  recurrenceUntil     DateTime?
  recurrenceGroupId   String?
  recurrenceWeekdays  String?
  teacher             Teacher             @relation(fields: [teacherId], references: [chatId])
  student             Student             @relation(fields: [studentId], references: [id])
  participants        LessonParticipant[]
  payments            Payment[]
  paymentEvents       PaymentEvent[]
  notificationLogs    NotificationLog[]
  createdAt           DateTime            @default(now())

  @@index([recurrenceGroupId])
}

model Payment {
  id               Int       @id @default(autoincrement())
  teacherStudentId Int
  lessonId         Int?
  amount           Int
  paidAt           DateTime  @default(now())
  comment          String?

  lesson          Lesson?         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  teacherStudent  TeacherStudent  @relation(fields: [teacherStudentId], references: [id])

  @@unique([teacherStudentId, lessonId])
  @@index([teacherStudentId])
  @@index([lessonId])
}

model PaymentEvent {
  id            Int                    @id @default(autoincrement())
  studentId     Int
  teacherId     BigInt?
  lessonId      Int?
  type          String
  lessonsDelta  Int
  priceSnapshot Int
  moneyAmount   Int?
  createdAt     DateTime               @default(now())
  createdBy     String
  reason        String?
  comment       String?

  student Student @relation(fields: [studentId], references: [id])
  lesson  Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([teacherId])
  @@index([lessonId])
  @@index([createdAt])
}

model LessonParticipant {
  id        Int      @id @default(autoincrement())
  lessonId  Int
  studentId Int
  price     Int      @default(0)
  isPaid    Boolean  @default(false)
  attended  Boolean? // null = not marked yet, true = attended, false = absent
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id])
  createdAt DateTime @default(now())

  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
}

model TeacherAuth {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  passwordHash String
  teacherId    BigInt  @unique
  teacher      Teacher @relation(fields: [teacherId], references: [chatId])
  createdAt    DateTime @default(now())
}

model User {
  id              Int             @id @default(autoincrement())
  telegramUserId  BigInt          @unique
  username        String?
  firstName       String?
  lastName        String?
  photoUrl        String?
  lastAuthDate    Int?
  role            String          @default("TEACHER")
  subscriptionStartAt DateTime?
  subscriptionEndAt   DateTime?
  onboardingTeacherCompleted Boolean @default(false)
  onboardingStudentCompleted Boolean @default(false)
  onboardingTeacherStartedAt DateTime?
  onboardingStudentStartedAt DateTime?
  lastOnboardingNudgeAt       DateTime?
  termsAccepted  Boolean   @default(false)
  termsAcceptedAt DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt
  sessions        Session[]
  transferTokens  TransferToken[]
}

model NotificationLog {
  id           Int       @id @default(autoincrement())
  teacherId    BigInt
  studentId    Int?
  lessonId     Int?
  type         String
  source       PaymentReminderSource?
  channel      NotificationChannel @default(TELEGRAM)
  scheduledFor DateTime?
  sentAt       DateTime?
  status       String
  errorText    String?
  dedupeKey    String?   @unique
  createdAt    DateTime  @default(now())

  teacher Teacher @relation(fields: [teacherId], references: [chatId])
  student Student? @relation(fields: [studentId], references: [id])
  lesson  Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([studentId])
  @@index([lessonId])
  @@index([teacherId, createdAt])
  @@index([studentId, createdAt])
  @@index([lessonId, createdAt])
  @@index([type])
}

enum LessonPaymentStatus {
  UNPAID
  PAID
}

enum LessonPaidSource {
  NONE
  BALANCE
  MANUAL
}

enum PaymentReminderSource {
  AUTO
  MANUAL
}

enum NotificationChannel {
  TELEGRAM
}

model Session {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  ip        String?
  userAgent String?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model TransferToken {
  id              Int       @id @default(autoincrement())
  userId          Int
  tokenHash       String    @unique
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  usedAt          DateTime?
  createdIp       String?
  createdUserAgent String?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([usedAt])
}
