generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Teacher {
  chatId                BigInt          @id
  username              String?
  name                  String?
  timezone              String?
  defaultLessonDuration Int             @default(60)
  reminderMinutesBefore Int             @default(30)
  lessonReminderEnabled Boolean         @default(true)
  lessonReminderMinutes Int             @default(30)
  dailySummaryEnabled   Boolean         @default(true)
  dailySummaryTime      String          @default("09:00")
  tomorrowSummaryEnabled Boolean        @default(false)
  tomorrowSummaryTime   String          @default("20:00")
  studentNotificationsEnabled Boolean   @default(true)
  studentUpcomingLessonTemplate String?
  studentPaymentDueTemplate String?
  studentPaymentRemindersEnabled Boolean @default(true)
  autoConfirmLessons    Boolean         @default(true)
  globalPaymentRemindersEnabled Boolean @default(true)
  paymentReminderDelayHours Int         @default(24)
  paymentReminderRepeatHours Int        @default(48)
  paymentReminderMaxCount Int           @default(3)
  notifyTeacherOnAutoPaymentReminder Boolean @default(false)
  notifyTeacherOnManualPaymentReminder Boolean @default(true)
  homeworkNotifyOnAssign Boolean        @default(true)
  homeworkReminder24hEnabled Boolean    @default(true)
  homeworkReminderMorningEnabled Boolean @default(true)
  homeworkReminderMorningTime String    @default("10:00")
  homeworkReminder3hEnabled Boolean     @default(false)
  homeworkOverdueRemindersEnabled Boolean @default(true)
  homeworkOverdueReminderTime String    @default("10:00")
  homeworkOverdueReminderMaxCount Int   @default(3)
  students              TeacherStudent[]
  homeworks             Homework[]
  homeworkTemplates     HomeworkTemplate[]  @relation("HomeworkTemplateTeacher")
  homeworkTemplatesCreated HomeworkTemplate[] @relation("HomeworkTemplateCreator")
  homeworkGroups        HomeworkGroup[]     @relation("HomeworkGroupTeacher")
  homeworkAssignments   HomeworkAssignment[] @relation("HomeworkAssignmentTeacher")
  homeworkSubmissionsReviewed HomeworkSubmission[] @relation("HomeworkSubmissionReviewer")
  lessons               Lesson[]
  notificationLogs      NotificationLog[]
  activityEvents        ActivityEvent[]
  activityFeedSeenAt    DateTime?
  createdAt             DateTime        @default(now())
  authUser              TeacherAuth?
}

model Student {
  id                   Int                  @id @default(autoincrement())
  username             String?
  telegramId           BigInt?
  isActivated          Boolean              @default(false)
  activatedAt          DateTime?
  timezone             String?
  pricePerLesson       Int                  @default(0)
  paymentRemindersEnabled Boolean           @default(true)
  teacherLinks         TeacherStudent[]
  homeworks            Homework[]           @relation("HomeworkStudent")
  takenHomeworks       Homework[]           @relation("HomeworkTakenBy")
  homeworkAssignments  HomeworkAssignment[] @relation("HomeworkAssignmentStudent")
  homeworkSubmissions  HomeworkSubmission[] @relation("HomeworkSubmissionStudent")
  lessons              Lesson[]
  lessonParticipations LessonParticipant[]
  paymentEvents        PaymentEvent[]
  notificationLogs     NotificationLog[]
  activityEvents       ActivityEvent[]
  createdAt            DateTime             @default(now())
}

model TeacherStudent {
  id                 Int      @id @default(autoincrement())
  teacherId          BigInt
  studentId          Int
  customName         String
  email              String?
  phone              String?
  studentLevel       String?
  learningGoal       String?
  notes              String?
  autoRemindHomework Boolean @default(false)
  balanceLessons     Int     @default(0)
  pricePerLesson     Int     @default(0)
  uiColor            String  @default("#5A8DFF")
  isArchived         Boolean @default(false)
  payments           Payment[]

  teacher Teacher @relation(fields: [teacherId], references: [chatId])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([teacherId, studentId])
}

model Homework {
  id        Int      @id @default(autoincrement())
  text      String
  deadline  DateTime?
  status    String   @default("DRAFT") // values: DRAFT, ASSIGNED, IN_PROGRESS, DONE
  isDone    Boolean  @default(false)
  attachments String @default("[]")
  timeSpentMinutes Int?
  completedAt DateTime?
  takenAt   DateTime?
  takenByStudentId Int?
  studentId Int
  teacherId BigInt
  student   Student  @relation("HomeworkStudent", fields: [studentId], references: [id])
  teacher   Teacher  @relation(fields: [teacherId], references: [chatId])
  takenByStudent Student? @relation("HomeworkTakenBy", fields: [takenByStudentId], references: [id])
  activityEvents ActivityEvent[]
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  lastReminderAt DateTime?
}

model HomeworkTemplate {
  id                 Int      @id @default(autoincrement())
  teacherId          BigInt
  createdByTeacherId BigInt?
  title              String
  tags               String   @default("[]")
  subject            String?
  level              String?
  blocks             String   @default("[]")
  isArchived         Boolean  @default(false)
  createdAt          DateTime @default(now())
  updatedAt          DateTime @default(now()) @updatedAt

  teacher            Teacher  @relation("HomeworkTemplateTeacher", fields: [teacherId], references: [chatId])
  createdByTeacher   Teacher? @relation("HomeworkTemplateCreator", fields: [createdByTeacherId], references: [chatId])
  assignments        HomeworkAssignment[]

  @@index([teacherId, isArchived, updatedAt])
}

model HomeworkGroup {
  id          Int      @id @default(autoincrement())
  teacherId   BigInt
  title       String
  description String?
  iconKey     String   @default("layer-group")
  bgColor     String   @default("#F3F4F6")
  sortOrder   Int      @default(0)
  isArchived  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now()) @updatedAt

  teacher     Teacher  @relation("HomeworkGroupTeacher", fields: [teacherId], references: [chatId])
  assignments HomeworkAssignment[]

  @@index([teacherId, isArchived, sortOrder, updatedAt])
}

model HomeworkAssignment {
  id                     Int      @id @default(autoincrement())
  teacherId              BigInt
  studentId              Int
  lessonId               Int?
  templateId             Int?
  groupId                Int?
  legacyHomeworkId       Int?
  title                  String
  status                 String   @default("DRAFT")
  sendMode               String   @default("MANUAL")
  deadlineAt             DateTime?
  sentAt                 DateTime?
  contentSnapshot        String   @default("[]")
  autoScore              Int?
  manualScore            Int?
  finalScore             Int?
  teacherComment         String?
  reviewedAt             DateTime?
  reminder24hSentAt      DateTime?
  reminderMorningSentAt  DateTime?
  reminder3hSentAt       DateTime?
  overdueReminderCount   Int      @default(0)
  lastOverdueReminderAt  DateTime?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @default(now()) @updatedAt

  teacher                Teacher  @relation("HomeworkAssignmentTeacher", fields: [teacherId], references: [chatId])
  student                Student  @relation("HomeworkAssignmentStudent", fields: [studentId], references: [id])
  lesson                 Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  template               HomeworkTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  group                  HomeworkGroup? @relation(fields: [groupId], references: [id], onDelete: SetNull)
  submissions            HomeworkSubmission[]

  @@index([teacherId, studentId, status])
  @@index([teacherId, lessonId])
  @@index([teacherId, groupId])
  @@index([studentId, deadlineAt])
  @@index([teacherId, deadlineAt])
  @@unique([legacyHomeworkId])
}

model HomeworkSubmission {
  id              Int      @id @default(autoincrement())
  assignmentId    Int
  studentId       Int
  reviewerTeacherId BigInt?
  attemptNo       Int
  status          String   @default("DRAFT")
  answerText      String?
  attachments     String   @default("[]")
  voice           String   @default("[]")
  testAnswers     String?
  autoScore       Int?
  manualScore     Int?
  finalScore      Int?
  teacherComment  String?
  reviewDraft     String?
  submittedAt     DateTime?
  reviewedAt      DateTime?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @default(now()) @updatedAt

  assignment      HomeworkAssignment @relation(fields: [assignmentId], references: [id], onDelete: Cascade)
  student         Student            @relation("HomeworkSubmissionStudent", fields: [studentId], references: [id])
  reviewerTeacher Teacher?           @relation("HomeworkSubmissionReviewer", fields: [reviewerTeacherId], references: [chatId])

  @@unique([assignmentId, attemptNo])
  @@index([assignmentId, status])
  @@index([studentId, submittedAt])
}

model Lesson {
  id                  Int                 @id @default(autoincrement())
  teacherId           BigInt
  studentId           Int
  price               Int                 @default(0)
  color               String              @default("blue")
  startAt             DateTime
  durationMinutes     Int
  status              String              @default("SCHEDULED") // values: SCHEDULED, COMPLETED, CANCELED
  isPaid              Boolean             @default(false)
  paidAt              DateTime?
  completedAt         DateTime?
  paymentStatus       LessonPaymentStatus @default(UNPAID)
  paidSource          LessonPaidSource    @default(NONE)
  lastPaymentReminderAt DateTime?
  paymentReminderCount Int               @default(0)
  lastPaymentReminderSource PaymentReminderSource?
  isRecurring         Boolean             @default(false)
  meetingLink         String?
  recurrenceUntil     DateTime?
  recurrenceGroupId   String?
  recurrenceWeekdays  String?
  teacher             Teacher             @relation(fields: [teacherId], references: [chatId])
  student             Student             @relation(fields: [studentId], references: [id])
  participants        LessonParticipant[]
  payments            Payment[]
  paymentEvents       PaymentEvent[]
  notificationLogs    NotificationLog[]
  activityEvents      ActivityEvent[]
  homeworkAssignments HomeworkAssignment[]
  createdAt           DateTime            @default(now())

  @@index([recurrenceGroupId])
}

model Payment {
  id               Int       @id @default(autoincrement())
  teacherStudentId Int
  lessonId         Int?
  amount           Int
  paidAt           DateTime  @default(now())
  comment          String?

  lesson          Lesson?         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  teacherStudent  TeacherStudent  @relation(fields: [teacherStudentId], references: [id])

  @@unique([teacherStudentId, lessonId])
  @@index([teacherStudentId])
  @@index([lessonId])
}

model PaymentEvent {
  id            Int                    @id @default(autoincrement())
  studentId     Int
  teacherId     BigInt?
  lessonId      Int?
  type          String
  lessonsDelta  Int
  priceSnapshot Int
  moneyAmount   Int?
  createdAt     DateTime               @default(now())
  createdBy     String
  reason        String?
  comment       String?

  student Student @relation(fields: [studentId], references: [id])
  lesson  Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([teacherId])
  @@index([lessonId])
  @@index([createdAt])
}

model LessonParticipant {
  id        Int      @id @default(autoincrement())
  lessonId  Int
  studentId Int
  price     Int      @default(0)
  isPaid    Boolean  @default(false)
  attended  Boolean? // null = not marked yet, true = attended, false = absent
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id])
  createdAt DateTime @default(now())

  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
}

model TeacherAuth {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  passwordHash String
  teacherId    BigInt  @unique
  teacher      Teacher @relation(fields: [teacherId], references: [chatId])
  createdAt    DateTime @default(now())
}

model User {
  id              Int             @id @default(autoincrement())
  telegramUserId  BigInt          @unique
  username        String?
  firstName       String?
  lastName        String?
  receiptEmail    String?
  photoUrl        String?
  lastAuthDate    Int?
  role            String          @default("TEACHER")
  subscriptionStartAt DateTime?
  subscriptionEndAt   DateTime?
  subscriptionTrialUsed Boolean   @default(false)
  onboardingTeacherCompleted Boolean @default(false)
  onboardingStudentCompleted Boolean @default(false)
  onboardingTeacherStartedAt DateTime?
  onboardingStudentStartedAt DateTime?
  lastOnboardingNudgeAt       DateTime?
  termsAccepted  Boolean   @default(false)
  termsAcceptedAt DateTime?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @default(now()) @updatedAt
  sessions        Session[]
  transferTokens  TransferToken[]
}

model NotificationLog {
  id           Int       @id @default(autoincrement())
  teacherId    BigInt
  studentId    Int?
  lessonId     Int?
  type         String
  source       PaymentReminderSource?
  channel      NotificationChannel @default(TELEGRAM)
  scheduledFor DateTime?
  sentAt       DateTime?
  status       String
  errorText    String?
  dedupeKey    String?   @unique
  createdAt    DateTime  @default(now())

  teacher Teacher @relation(fields: [teacherId], references: [chatId])
  student Student? @relation(fields: [studentId], references: [id])
  lesson  Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([teacherId])
  @@index([studentId])
  @@index([lessonId])
  @@index([teacherId, createdAt])
  @@index([studentId, createdAt])
  @@index([lessonId, createdAt])
  @@index([type])
}

model ActivityEvent {
  id         Int      @id @default(autoincrement())
  teacherId  BigInt
  studentId  Int?
  lessonId   Int?
  homeworkId Int?
  category   String
  action     String
  status     String
  source     String
  title      String
  details    String?
  payload    String?
  occurredAt DateTime @default(now())
  createdAt  DateTime @default(now())
  dedupeKey  String?  @unique

  teacher  Teacher  @relation(fields: [teacherId], references: [chatId])
  student  Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)
  lesson   Lesson?  @relation(fields: [lessonId], references: [id], onDelete: SetNull)
  homework Homework? @relation(fields: [homeworkId], references: [id], onDelete: SetNull)

  @@index([teacherId, occurredAt])
  @@index([teacherId, category, occurredAt])
  @@index([teacherId, studentId, occurredAt])
}

enum LessonPaymentStatus {
  UNPAID
  PAID
}

enum LessonPaidSource {
  NONE
  BALANCE
  MANUAL
}

enum PaymentReminderSource {
  AUTO
  MANUAL
}

enum NotificationChannel {
  TELEGRAM
}

model Session {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
  ip        String?
  userAgent String?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([expiresAt])
}

model TransferToken {
  id              Int       @id @default(autoincrement())
  userId          Int
  tokenHash       String    @unique
  createdAt       DateTime  @default(now())
  expiresAt       DateTime
  usedAt          DateTime?
  createdIp       String?
  createdUserAgent String?

  user User @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([usedAt])
}
