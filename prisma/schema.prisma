generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model Teacher {
  chatId                BigInt          @id
  username              String?
  name                  String?
  defaultLessonDuration Int             @default(60)
  reminderMinutesBefore Int             @default(30)
  students              TeacherStudent[]
  homeworks             Homework[]
  lessons               Lesson[]
  createdAt             DateTime        @default(now())
  authUser              TeacherAuth?
}

model Student {
  id                   Int                  @id @default(autoincrement())
  username             String?
  telegramId           BigInt?
  pricePerLesson       Int                  @default(0)
  teacherLinks         TeacherStudent[]
  homeworks            Homework[]           @relation("HomeworkStudent")
  takenHomeworks       Homework[]           @relation("HomeworkTakenBy")
  lessons              Lesson[]
  lessonParticipations LessonParticipant[]
  paymentEvents        PaymentEvent[]
  createdAt            DateTime             @default(now())
}

model TeacherStudent {
  id                 Int      @id @default(autoincrement())
  teacherId          BigInt
  studentId          Int
  customName         String
  autoRemindHomework Boolean @default(false)
  balanceLessons     Int     @default(0)
  payments           Payment[]

  teacher Teacher @relation(fields: [teacherId], references: [chatId])
  student Student @relation(fields: [studentId], references: [id])

  @@unique([teacherId, studentId])
}

model Homework {
  id        Int      @id @default(autoincrement())
  text      String
  deadline  DateTime?
  status    String   @default("DRAFT") // values: DRAFT, ASSIGNED, IN_PROGRESS, DONE
  isDone    Boolean  @default(false)
  attachments String @default("[]")
  timeSpentMinutes Int?
  completedAt DateTime?
  takenAt   DateTime?
  takenByStudentId Int?
  studentId Int
  teacherId BigInt
  student   Student  @relation("HomeworkStudent", fields: [studentId], references: [id])
  teacher   Teacher  @relation(fields: [teacherId], references: [chatId])
  takenByStudent Student? @relation("HomeworkTakenBy", fields: [takenByStudentId], references: [id])
  createdAt DateTime @default(now())
  updatedAt DateTime @default(now()) @updatedAt
  lastReminderAt DateTime?
}

model Lesson {
  id                  Int                 @id @default(autoincrement())
  teacherId           BigInt
  studentId           Int
  price               Int                 @default(0)
  startAt             DateTime
  durationMinutes     Int
  status              String              @default("SCHEDULED") // values: SCHEDULED, COMPLETED, CANCELED
  isPaid              Boolean             @default(false)
  isRecurring         Boolean             @default(false)
  recurrenceUntil     DateTime?
  recurrenceGroupId   String?
  recurrenceWeekdays  String?
  teacher             Teacher             @relation(fields: [teacherId], references: [chatId])
  student             Student             @relation(fields: [studentId], references: [id])
  participants        LessonParticipant[]
  payments            Payment[]
  paymentEvents       PaymentEvent[]
  createdAt           DateTime            @default(now())

  @@index([recurrenceGroupId])
}

model Payment {
  id               Int       @id @default(autoincrement())
  teacherStudentId Int
  lessonId         Int?
  amount           Int
  paidAt           DateTime  @default(now())
  comment          String?

  lesson          Lesson?         @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  teacherStudent  TeacherStudent  @relation(fields: [teacherStudentId], references: [id])

  @@unique([teacherStudentId, lessonId])
  @@index([teacherStudentId])
  @@index([lessonId])
}

enum PaymentEventType {
  TOP_UP
  AUTO_CHARGE
  MANUAL_PAID
  ADJUSTMENT
}

enum PaymentEventCreatedBy {
  TEACHER
  SYSTEM
}

model PaymentEvent {
  id            Int                    @id @default(autoincrement())
  studentId     Int
  lessonId      Int?
  type          PaymentEventType
  lessonsDelta  Int
  priceSnapshot Int
  moneyAmount   Int?
  createdAt     DateTime               @default(now())
  createdBy     PaymentEventCreatedBy
  reason        String?

  student Student @relation(fields: [studentId], references: [id])
  lesson  Lesson? @relation(fields: [lessonId], references: [id], onDelete: Cascade)

  @@index([studentId])
  @@index([lessonId])
  @@index([createdAt])
  @@unique([studentId, lessonId, type])
}

model LessonParticipant {
  id        Int      @id @default(autoincrement())
  lessonId  Int
  studentId Int
  price     Int      @default(0)
  isPaid    Boolean  @default(false)
  attended  Boolean? // null = not marked yet, true = attended, false = absent
  lesson    Lesson   @relation(fields: [lessonId], references: [id], onDelete: Cascade)
  student   Student  @relation(fields: [studentId], references: [id])
  createdAt DateTime @default(now())

  @@unique([lessonId, studentId])
  @@index([lessonId])
  @@index([studentId])
}

model TeacherAuth {
  id           Int     @id @default(autoincrement())
  email        String  @unique
  passwordHash String
  teacherId    BigInt  @unique
  teacher      Teacher @relation(fields: [teacherId], references: [chatId])
  createdAt    DateTime @default(now())
}
